<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>My Shop</title>
    {% load static %}
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <style>
      body {
        background-color: #cccccc;
      }
      .cart-item {
        display: flex;
        align-items: center;
        justify-content: space-between;
        padding: 8px 0;
        border-bottom: 1px solid #eee;
      }
      .cart-item img {
        width: 40px;
        height: 40px;
        object-fit: cover;
        margin-right: 10px;
        border-radius: 5px;
      }
      .cart-total {
        font-weight: bold;
        margin-top: 10px;
        text-align: right;
      }
      .qty-controls {
        display: flex;
        align-items: center;
        gap: 10px;
      }
      .qty-controls button {
        width: 32px;
        height: 32px;
        border-radius: 50%;
        padding: 0;
      }

      .ethnic-img {
        width: 220px; /* fixed width */
        height: 500px; /* fixed height */
        object-fit: cover; /* crop proportionally without stretching */
        display: block;
        margin: 0 auto; /* center inside the card */
        border-radius: 5px; /* optional rounded corners */
        background-color: #f8f8f8; /* fallback background */
      }
      .l {
        margin-left: 100px;
        width: 750px;
      }
      .l:hover {
        border: 2px solid orange;
      }
    </style>
  </head>
  <body>
    <!-- Navbar -->
    <nav class="navbar navbar-expand-lg navbar-dark bg-dark">
      <div class="container-fluid">
        <a class="navbar-brand" href="#" style="color: orange"><b>MyShop</b></a>
        <button
          class="navbar-toggler"
          type="button"
          data-bs-toggle="collapse"
          data-bs-target="#navbarNav"
        >
          <span class="navbar-toggler-icon"></span>
        </button>

        <div class="collapse navbar-collapse" id="navbarNav">
          <!-- Search Form -->
          <form class="d-flex me-auto" method="GET" action="{% url 'search' %}">
            <input
              class="form-control me-2 l"
              type="search"
              placeholder="Search products..."
              aria-label="Search"
              name="query"
              value="{{ query|default:'' }}"
            />
            <button
              class="btn btn-outline-light"
              type="submit"
              style="color: orange; border: 1px solid orange"
            >
              Search
            </button>
          </form>

          <!-- Navbar Links -->
          <ul class="navbar-nav ms-auto">
            <li class="nav-item">
              <a class="nav-link active" href="#">Home</a>
            </li>
            <li class="nav-item">
              <a class="nav-link" href="{% url 'about' %}">About</a>
            </li>
            <li class="nav-item">
              <a class="nav-link" href="{% url 'contact' %}">Contact</a>
            </li>
            <li class="nav-item">
              <a class="nav-link" href="{% url 'tracker' %}">Track</a>
            </li>

            <!-- Cart Button -->
            <li class="nav-item dropdown">
              <a
                href="#"
                class="btn btn-success dropdown-toggle"
                data-bs-toggle="dropdown"
              >
                Cart (<span id="cart-count">0</span>)
              </a>
              <a class="btn btn-success ms-2" href="{% url 'checkout' %}"
                >Checkout</a
              >
              <ul
                class="dropdown-menu dropdown-menu-end p-3"
                style="min-width: 280px"
                id="cartPreview"
              >
                <p class="text-muted">Cart is empty</p>
              </ul>
            </li>
          </ul>
        </div>
      </div>
    </nav>

    <!-- Welcome Section -->
    <div class="container my-4">
      <h1 class="text-center">
        Welcome to <b style="color: orange">MyShop</b>
      </h1>
    </div>

    <!-- Products Loop -->
    {% for chunks, nslides, cat in allProds %}
    <div class="container my-5">
      <h3 class="mb-3">{{ cat }}</h3>
      <div
        id="carousel{{ forloop.counter }}"
        class="carousel slide"
        data-bs-ride="carousel"
      >
        <div class="carousel-inner">
          {% for group in chunks %}
          <div class="carousel-item {% if forloop.first %}active{% endif %}">
            <div class="row">
              {% for product in group %}
              <div class="col-md-4 mb-3">
                <div class="card h-100">
                  <img
                    src="{% if product.image %}{{ product.image.url }}{% else %}{% static 'shop/images/no-image.png' %}{% endif %}"
                    class="card-img-top ethnic-img"
                    style="
                      height: 310px;
                      width: 250px;
                      object-fit: cover;
                      margin-left: 60px;
                      margin-top: 50px;
                    "
                    alt="{{ product.product_name }}"
                  />

                  <div class="card-body">
                    <h5 class="card-title">{{ product.product_name }}</h5>
                    <p class="card-text">{{ product.product_desc }}</p>
                    <p class="text-success">₹{{ product.price }}</p>

                    <div
                      id="controls-{{ product.product_id }}"
                      data-id="{{ product.product_id }}"
                      data-name="{{ product.product_name }}"
                      data-price="{{ product.price }}"
                      data-image="{% if product.image %}{{ product.image.url }}{% else %}{% static 'shop/images/no-image.png' %}{% endif %}"
                    >
                      <button
                        class="btn btn-primary add-to-cart"
                        data-id="{{ product.product_id }}"
                        style="
                          background-color: #ff9900;
                          border: 1px solid black;
                        "
                        data-name="{{ product.product_name }}"
                        data-price="{{ product.price }}"
                        data-image="{% if product.image %}{{ product.image.url }}{% else %}{% static 'shop/images/no-image.png' %}{% endif %}"
                      >
                        Add to Cart
                      </button>
                      <a href="/shop/product/{{ product.product_id }}">
                        <button
                          style="
                            background-color: rgb(110, 244, 110);
                            height: 35px;
                            border-radius: 5px;
                          "
                          data-id="{{ product.product_id }}"
                        >
                          Quick View
                        </button>
                      </a>
                    </div>
                  </div>
                </div>
              </div>
              {% endfor %}
            </div>
          </div>
          {% endfor %}
        </div>

        <div class="d-flex justify-content-between mt-3">
          <button
            class="btn btn-outline-dark"
            type="button"
            data-bs-target="#carousel{{ forloop.counter }}"
            data-bs-slide="prev"
          >
            ‹ Prev
          </button>
          <button
            class="btn btn-outline-dark"
            type="button"
            data-bs-target="#carousel{{ forloop.counter }}"
            data-bs-slide="next"
          >
            Next ›
          </button>
        </div>
      </div>
    </div>
    {% endfor %}

    <!-- Search Results Section -->
    {% if query %} {% if result %}
    <div class="container my-5">
      <h3 class="mb-3">Search Results for "{{ query }}"</h3>
      <div class="row">
        {% for p in result %}
        <div class="col-md-4 mb-3">
          <div class="card h-100">
            <img
              src="{% if p.image %}{{ p.image.url }}{% else %}{% static 'shop/images/no-image.png' %}{% endif %}"
              class="card-img-top"
              style="height: 200px; object-fit: cover"
              alt="{{ p.product_name }}"
            />
            <div class="card-body">
              <h5 class="card-title">{{ p.product_name }}</h5>
              <p class="card-text">{{ p.product_desc }}</p>
              <p class="text-success">₹{{ p.price }}</p>
              <a href="/shop/product/{{ p.product_id }}" class="btn btn-primary"
                >Quick View</a
              >
            </div>
          </div>
        </div>
        {% endfor %}
      </div>
    </div>
    {% else %}
    <script>
      alert("No products match your search query!");
    </script>
    {% endif %} {% endif %}
    <footer class="bg-dark text-light py-3 text-center">
      <p class="mb-0">&copy; 2025 My Shop. All Rights Reserved.</p>
    </footer>

    <!-- Cart Script -->
    <script>
      let cart = JSON.parse(localStorage.getItem("cart")) || {};

      function saveCart() {
        localStorage.setItem("cart", JSON.stringify(cart));
      }

      function updateCartCount() {
        const validItems = Object.values(cart).filter(
          (item) => item && item.qty && !isNaN(item.qty)
        );
        const count = validItems.reduce((sum, i) => sum + Number(i.qty), 0);
        document.getElementById("cart-count").innerText = count;
        renderCartPreview();
      }

      function renderCartPreview() {
        const preview = document.getElementById("cartPreview");
        preview.innerHTML = "";
        const items = Object.values(cart).filter(
          (item) => item && item.name && item.price !== undefined && item.qty
        );

        if (!items.length) {
          preview.innerHTML = '<p class="text-muted">Cart is empty</p>';
          return;
        }

        let total = 0;
        items.forEach((item) => {
          const price = parseFloat(item.price) || 0;
          total += price * item.qty;
          const imgSrc =
            item.image || "{% static 'shop/images/no-image.png' %}";
          preview.innerHTML += `
          <div class="cart-item">
            <img src="${imgSrc}" alt="${item.name}" />
            <div>
              <div>${item.name}</div>
              <small>₹${price} × ${item.qty}</small>
            </div>
          </div>`;
        });

        preview.innerHTML += `<div class="cart-total">Total: ₹${total}</div>`;
      }

      function renderControls(productId) {
        const container = document.getElementById("controls-" + productId);
        if (!container) return;
        const { name, price, image } = container.dataset;

        if (cart[productId]) {
          container.innerHTML = `
          <div class="qty-controls">
            <button class="btn btn-danger decrease" data-id="${productId}">-</button>
            <span>${cart[productId].qty}</span>
            <button class="btn btn-success increase" data-id="${productId}">+</button>
          </div>`;
        } else {
          container.innerHTML = `
          <button
            class="btn btn-primary add-to-cart"
            data-id="${productId}"
            data-name="${name}"
            data-price="${price}"
            data-image="${image}">
            Add to Cart
          </button>`;
        }
        attachEvents();
      }

      function attachEvents() {
        document.querySelectorAll(".add-to-cart").forEach((btn) => {
          btn.onclick = () => {
            const { id, name, price, image } = btn.dataset;
            if (!cart[id])
              cart[id] = { name, price: parseFloat(price) || 0, qty: 1, image };
            else cart[id].qty++;
            saveCart();
            updateCartCount();
            renderControls(id);
          };
        });

        document.querySelectorAll(".increase").forEach((btn) => {
          btn.onclick = () => {
            const id = btn.dataset.id;
            cart[id].qty++;
            saveCart();
            updateCartCount();
            renderControls(id);
          };
        });

        document.querySelectorAll(".decrease").forEach((btn) => {
          btn.onclick = () => {
            const id = btn.dataset.id;
            cart[id].qty--;
            if (cart[id].qty <= 0) delete cart[id];
            saveCart();
            updateCartCount();
            renderControls(id);
          };
        });
      }

      window.onload = () => {
        cart = JSON.parse(localStorage.getItem("cart")) || {};
        Object.keys(cart).forEach((id) => renderControls(id));
        updateCartCount();
        attachEvents();
      };
    </script>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
  </body>
</html>
