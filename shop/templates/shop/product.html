<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>{{ product.product_name }} - My Shop</title>
    {% load static %}
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>

    <style>
      /* Base */
      body {
        background: #f9f9f9;
        font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
        -webkit-font-smoothing: antialiased;
        -moz-osx-font-smoothing: grayscale;
      }

      .product-wrapper {
        max-width: 1100px;
        margin: 36px auto;
        padding: 0 15px;
      }

      .product-card {
        background: #fff;
        padding: 24px;
        border-radius: 12px;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
      }

      /* IMAGE ALIGNMENT FIX */
      .img-container {
        width: 100%;
        border-radius: 8px;
        overflow: hidden;
        background-color: #f1f1f1;
        display: flex;
        align-items: center;
        justify-content: center;
        min-height: 250px; /* fallback height */
      }

      .img-container img {
        width: 100%;
        height: auto;
        max-height: 500px;
        object-fit: contain;
        display: block;
      }

      /* Product details */
      .product-title {
        color: rgb(228, 80, 80);
        font-weight: 700;
        font-size: 1.5rem;
      }

      .product-price {
        color: #dc3545;
        font-size: 1.25rem;
        font-weight: 700;
        margin-top: 6px;
      }

      .product-desc {
        color: #6c757d;
        margin-top: 12px;
      }

      .controls {
        display: flex;
        gap: 10px;
        align-items: center;
        margin-top: 14px;
        flex-wrap: wrap;
      }

      .controls .btn {
        min-width: 140px;
      }

      .qty-controls {
        display: flex;
        align-items: center;
        gap: 10px;
      }

      .qty-controls button {
        width: 30px;
        height: 32px;
        border-radius: 5%;
        padding: 0;
      }

      /* Responsive tweaks */
      @media (max-width: 992px) {
        .product-title {
          font-size: 1.35rem;
        }
      }

      @media (max-width: 768px) {
        .product-card {
          padding: 18px;
        }
      }

      @media (max-width: 576px) {
        .col-md-6 {
          flex: 0 0 100% !important;
          max-width: 100% !important;
        }
        .controls {
          flex-direction: column;
          align-items: stretch;
        }
        .controls .btn {
          width: 100%;
        }
        .qty-controls {
          justify-content: flex-start;
        }
      }

      .nav-cart-btn {
        min-width: 120px;
      }
    </style>
  </head>

  <body>
    <!-- Navbar -->
    <nav class="navbar navbar-expand-lg navbar-dark bg-dark">
      <div class="container-fluid">
        <a class="navbar-brand" href="/" style="color: orange">MyShop</a>
        <div class="ms-auto">
          <a href="{% url 'checkout' %}" class="btn btn-success nav-cart-btn">
            Cart (<span id="cart-count">0</span>)
          </a>
        </div>
      </div>
    </nav>

    <!-- Product Container -->
    <div class="product-wrapper">
      <div class="product-card">
        <div class="row g-4 align-items-start">
          <!-- Image column -->
          <div class="col-md-6">
            <div class="img-container">
              {% if product.image %}
              <img
                src="{{ product.image.url }}"
                alt="{{ product.product_name }}"
              />
              {% else %}
              <img
                src="{% static 'shop/images/no-image.png' %}"
                alt="No Image"
              />
              {% endif %}
            </div>
          </div>

          <!-- Details column -->
          <div class="col-md-6 d-flex flex-column">
            <h2 class="product-title mb-1">{{ product.product_name }}</h2>
            <div class="product-price">Price: â‚¹{{ product.price }}</div>
            <p class="product-desc">{{ product.description }}</p>

            <!-- Buttons / Controls -->
            <div
              id="controls-{{ product.product_id }}"
              data-id="{{ product.product_id }}"
              data-name="{{ product.product_name }}"
              data-price="{{ product.price }}"
              data-image="{% if product.image %}{{ product.image.url }}{% else %}{% static 'shop/images/no-image.png' %}{% endif %}"
              class="mt-auto"
            >
              <!-- Buttons rendered by JS -->
            </div>

            <!-- More products link (visible on mobile) -->
            <div class="mt-3 d-block d-md-none">
              <a href="{% url 'shop' %}" class="btn btn-warning w-100"
                >More Products</a
              >
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Cart Script -->
    <script>
      let cart = JSON.parse(localStorage.getItem("cart")) || {};

      function saveCart() {
        localStorage.setItem("cart", JSON.stringify(cart));
      }

      function updateCartCount() {
        const count = Object.values(cart).reduce(
          (sum, i) => sum + Number(i.qty || 0),
          0
        );
        const el = document.getElementById("cart-count");
        if (el) el.innerText = count;
      }

      function renderControls(productId) {
        const container = document.getElementById("controls-" + productId);
        if (!container) return;
        const { name, price, image } = container.dataset;

        if (cart[productId]) {
          container.innerHTML = `
            <div class="controls">
              <div class="qty-controls">
                <button class="btn btn-danger decrease" data-id="${productId}">-</button>
                <span style="min-width:36px; text-align:center;">${cart[productId].qty}</span>
                <button class="btn btn-success increase" data-id="${productId}">+</button>
              </div>

              <button class="btn btn-danger buy-now"
                data-id="${productId}"
                data-name="${name}"
                data-price="${price}"
                data-image="${image}">
                Buy Now
              </button>

              <a href="{% url 'shop' %}" class="btn btn-warning d-none d-md-inline">More Products</a>
            </div>
          `;
        } else {
          container.innerHTML = `
            <div class="controls">
              <button class="btn btn-primary add-to-cart"
                data-id="${productId}"
                data-name="${name}"
                data-price="${price}"
                data-image="${image}">
                Add to Cart
              </button>

              <button class="btn btn-danger buy-now"
                data-id="${productId}"
                data-name="${name}"
                data-price="${price}"
                data-image="${image}">
                Buy Now
              </button>

              <a href="{% url 'shop' %}" class="btn btn-warning d-none d-md-inline">More Products</a>
            </div>
          `;
        }
        attachEvents();
      }

      function attachEvents() {
        document.querySelectorAll(".add-to-cart").forEach((btn) => {
          btn.onclick = () => {
            const { id, name, price, image } = btn.dataset;
            if (!cart[id])
              cart[id] = { name, price: parseFloat(price) || 0, qty: 1, image };
            else cart[id].qty++;
            saveCart();
            updateCartCount();
            renderControls(id);
          };
        });

        document.querySelectorAll(".increase").forEach((btn) => {
          btn.onclick = () => {
            const id = btn.dataset.id;
            cart[id].qty++;
            saveCart();
            updateCartCount();
            renderControls(id);
          };
        });

        document.querySelectorAll(".decrease").forEach((btn) => {
          btn.onclick = () => {
            const id = btn.dataset.id;
            cart[id].qty--;
            if (cart[id].qty <= 0) delete cart[id];
            saveCart();
            updateCartCount();
            renderControls(id);
          };
        });

        document.querySelectorAll(".buy-now").forEach((btn) => {
          btn.onclick = () => {
            const { id, name, price, image } = btn.dataset;
            if (!cart[id])
              cart[id] = { name, price: parseFloat(price) || 0, qty: 1, image };
            saveCart();
            updateCartCount();
            window.location.href = "{% url 'checkout' %}";
          };
        });
      }

      window.onload = () => {
        cart = JSON.parse(localStorage.getItem("cart")) || {};
        renderControls("{{ product.product_id }}");
        updateCartCount();
        attachEvents();
      };
    </script>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
  </body>
</html>
