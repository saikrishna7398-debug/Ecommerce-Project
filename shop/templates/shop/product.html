<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>{{ product.product_name }} - My Shop</title>
    {% load static %}
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <style>
      body {
        background: #f9f9f9;
      }
      .container {
        max-width: 700px;
        margin: 40px auto;
        background: #fff;
        padding: 25px;
        border-radius: 12px;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
      }
      img {
        max-width: 100%;
        border-radius: 8px;
      }
      .btn {
        margin: 5px 5px 5px 0;
      }
      .qty-controls {
        display: flex;
        align-items: center;
        gap: 10px;
        margin-bottom: 10px;
      }
      .qty-controls button {
        width: 32px;
        height: 32px;
        border-radius: 50%;
        padding: 0;
      }
    </style>
  </head>
  <body>
    <!-- Navbar -->
    <nav class="navbar navbar-expand-lg navbar-dark bg-dark">
      <div class="container-fluid">
        <a class="navbar-brand" href="/" style="color: orange">MyShop</a>
        <div class="ms-auto">
          <a href="{% url 'checkout' %}" class="btn btn-success">
            Cart (<span id="cart-count">0</span>)
          </a>
        </div>
      </div>
    </nav>

    <!-- Product Container -->
    <div class="container">
      <h2 class="mb-3" style="color: rgb(228, 80, 80)">
        {{ product.product_name }}
      </h2>
      <img
        style="margin-left: 250px; height: auto"
        src="/media/{{ product.image }}"
        alt="{{ product.product_name }}"
      />
      <h4 class="text-danger mt-3">Price: â‚¹{{ product.price }}</h4>
      <p class="text-muted">{{ product.description }}</p>

      <!-- Buttons -->
      <div
        id="controls-{{ product.product_id }}"
        data-id="{{ product.product_id }}"
        data-name="{{ product.product_name }}"
        data-price="{{ product.price }}"
        data-image="/media/{{ product.image }}"
      >
        <button
          class="btn btn-primary add-to-cart"
          data-id="{{ product.product_id }}"
          data-name="{{ product.product_name }}"
          data-price="{{ product.price }}"
          data-image="/media/{{ product.image }}"
        >
          Add to Cart
        </button>

        <button
          class="btn btn-danger buy-now"
          data-id="{{ product.product_id }}"
          data-name="{{ product.product_name }}"
          data-price="{{ product.price }}"
          data-image="/media/{{ product.image }}"
        >
          Buy Now
        </button>

        <a href="{% url 'shop' %}" class="btn btn-warning">More Products</a>
      </div>
    </div>

    <!-- Cart Script -->
    <script>
      let cart = JSON.parse(localStorage.getItem("cart")) || {};

      function saveCart() {
        localStorage.setItem("cart", JSON.stringify(cart));
      }

      function updateCartCount() {
        const count = Object.values(cart).reduce(
          (sum, i) => sum + Number(i.qty || 0),
          0
        );
        document.getElementById("cart-count").innerText = count;
      }

      function renderControls(productId) {
        const container = document.getElementById("controls-" + productId);
        if (!container) return;
        const { name, price, image } = container.dataset;

        if (cart[productId]) {
          container.innerHTML = `
          <div class="qty-controls">
            <button class="btn btn-danger decrease" data-id="${productId}">-</button>
            <span>${cart[productId].qty}</span>
            <button class="btn btn-success increase" data-id="${productId}">+</button>
          </div>
          <button class="btn btn-danger buy-now" 
            data-id="${productId}" 
            data-name="${name}" 
            data-price="${price}" 
            data-image="${image}">
            Buy Now
          </button>
          <a href="{% url 'shop' %}" class="btn btn-warning">More Products</a>`;
        } else {
          container.innerHTML = `
          <button class="btn btn-primary add-to-cart" 
            data-id="${productId}" 
            data-name="${name}" 
            data-price="${price}" 
            data-image="${image}">
            Add to Cart
          </button>
          <button class="btn btn-danger buy-now" 
            data-id="${productId}" 
            data-name="${name}" 
            data-price="${price}" 
            data-image="${image}">
            Buy Now
          </button>
          <a href="{% url 'shop' %}" class="btn btn-warning">More Products</a>`;
        }
        attachEvents();
      }

      function attachEvents() {
        // Add to Cart
        document.querySelectorAll(".add-to-cart").forEach((btn) => {
          btn.onclick = () => {
            const { id, name, price, image } = btn.dataset;
            if (!cart[id])
              cart[id] = { name, price: parseFloat(price) || 0, qty: 1, image };
            else cart[id].qty++;
            saveCart();
            updateCartCount();
            renderControls(id);
          };
        });

        // Increase
        document.querySelectorAll(".increase").forEach((btn) => {
          btn.onclick = () => {
            const id = btn.dataset.id;
            cart[id].qty++;
            saveCart();
            updateCartCount();
            renderControls(id);
          };
        });

        // Decrease
        document.querySelectorAll(".decrease").forEach((btn) => {
          btn.onclick = () => {
            const id = btn.dataset.id;
            cart[id].qty--;
            if (cart[id].qty <= 0) delete cart[id];
            saveCart();
            updateCartCount();
            renderControls(id);
          };
        });

        // Buy Now
        document.querySelectorAll(".buy-now").forEach((btn) => {
          btn.onclick = () => {
            const { id, name, price, image } = btn.dataset;
            if (!cart[id])
              cart[id] = { name, price: parseFloat(price) || 0, qty: 1, image };
            saveCart();
            updateCartCount();
            window.location.href = "{% url 'checkout' %}";
          };
        });
      }

      window.onload = () => {
        cart = JSON.parse(localStorage.getItem("cart")) || {};
        renderControls("{{ product.product_id }}");
        updateCartCount();
        attachEvents();
      };
    </script>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
  </body>
</html>
